<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\in-app-purchase-2.0.0.js - InAppPurchase</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="InAppPurchase"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Kiwi.Plugins.InAppPurchase.html">Kiwi.Plugins.InAppPurchase</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Kiwi.html">Kiwi</a></li>
            
                <li><a href="../modules/Plugins.html">Plugins</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\in-app-purchase-2.0.0.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
* The InAppPurchase plugin is designed to help make intergrating the CocoonJS IAP with Kiwi easier. 
* When a game is created, a new manager will be added to the &#x27;game&#x27; root which is a instanted version of this class, under the property &#x27;inAppPurchase&#x27;. You can then access that object to make a purchase or fetch purchases from the store.  
* 
* @module Kiwi
* @submodule Plugins
* @namespace Kiwi.Plugins
* @class InAppPurchase
*/
Kiwi.Plugins.InAppPurchase = {

    /**
    * The name of this plugin.
    * @property name
    * @type String
    * @public
    */
	name: &#x27;InAppPurchase&#x27;,

    /**
    * The version of this plugin in semver (semantic versioning) format
    * @property version
    * @type String
    * @public
    */
    version: &#x27;2.0.0&#x27;,

    /**
    * The minimum version of Kiwi.js required to run this plugin in semver (semantic versioning) format
    * @property minimumKiwiVersion
    * @type String
    * @public
    */
    minimumKiwiVersion:&#x27;1.3.0&#x27;,

    /**
    * If the device is ready to be used or not. 
    * @property deviceReady
    * @type Boolean
    * @default false
    * @public
    */
    deviceReady: false,

};
   
Kiwi.PluginManager.register(Kiwi.Plugins.InAppPurchase);


document.addEventListener(&#x27;deviceready&#x27;, function() {

	/**
	* Waits for the device ready event to be executed.
	* 
	* At this point we can execute IAP code without errors occuring as 
	* the appropriate code will now be accessible. 
	*/

	Kiwi.Plugins.InAppPurchase.deviceReady = true;
});


/**
* The create method is executed automatically by the PluginManager when it is included in a game. Internal Use ONLY.
* @method create
* @param game {Game} The game that this plugin belongs to.
* @protected
*/
Kiwi.Plugins.InAppPurchase.create = function(game) {

	game.inAppPurchase = new Kiwi.Plugins.InAppPurchase.InAppPurchase(game);
	
	return game.inAppPurchase; //Boot method here...
};



Kiwi.Plugins.InAppPurchase.InAppPurchase = function(game) {

	/**
	* The game this belongs to.
	* @property game
	* @type Game
	* @public
	*/
	this.game = game;

};


Kiwi.Plugins.InAppPurchase.InAppPurchase.prototype = {

	boot: function() {

		/**
		* Executed when the game&#x27;s DOM has been loaded and all assets have been set-up. Internal Use only.
		* @method boot
		* @protected
		*/

		/**
		* If the IAPs are ready to be purchased or not. 
		* Will be false if the &#x60;init&#x60; method is yet to be executed.
		* 
		* @property active
		* @type boolean
		* @default false
		* @readOnly
		* @public
		*/
		this.active = false;

		/**
		* Executed when a purchase is being made.
		*
		* @property onPurchaseStartedCallback
		* @type Function
		* @default null
		* @public
		*/
		this.onPurchaseStarted = new Kiwi.Signal();

		/**
		* Executed when a purchase failed to complete.
		* 
		* @property onPurchaseFailedCallback
		* @type Function
		* @default null
		* @public
		*/
		this.onPurchaseFailed = new Kiwi.Signal();

		/**
		* Executed when a purchase was successful.
		* 
		* @property onPurchaseCompleteCallback
		* @type Function
		* @default null
		* @public
		*/
		this.onPurchaseComplete = new Kiwi.Signal();

	},

	objType: function() {

		/**
		* The type of object that this is.
		* @method objType
		* @return {String}
		* @public
		*/

		return &#x27;inAppPurchase&#x27;;
	},

	log: function( message ) {

		/**
		* Shortcut to log a message with fixed information related to this plugin added.
		* 
		* @method log
		* @param message {String}
		*/

		if( this.game.debugOption === Kiwi.DEBUG_ON ) {
			Kiwi.Log.log( &#x27;IAP:&#x27;, message, &#x27;#inAppPurchase&#x27; );
		}

	},

	available: function() {

		/**
		* Returns a flag indicating if IAP methods can be executed or not.
		* 
		* @method available
		* @return {Boolean}
		*/

		return ( 
			Kiwi.Plugins.InAppPurchase.deviceReady &amp;&amp; 
			this.active &amp;&amp;
			Cocoon.InApp.canPurchase() );

	},

	init: function(productIds, callback, context) {

		/**
		* Initalises the store if it is avaiable. 
		* Starts fetching products from the store if an array of productIds were passed. 
		* 
		* @method init
		* @param [productIds] {Array} 
		* @param [callback] {Function} 
		* @param [context] {Any} 
		* @return {Boolean}
		*/

		if( !Kiwi.Plugins.InAppPurchase.deviceReady ) {
			this.log(&#x27;Could not initialise store. Device not ready yet&#x27;);
		 	return false; 
		}

		if( typeof Cocoon == &quot;undefined&quot; || typeof Cocoon.InApp == &quot;undefined&quot; ) {
			this.log(&quot;Could not initialise store. Cocoon Namespaces not found&quot;);
			return false; 
		}

		this.log( &#x27;Initialisation Starting&#x27; );
		this._startEvents();

		var self = this;
		Cocoon.InApp.initialize( {
	    	autofinish: true
		}, function( error ) {

			self.active = !!(error);

			if( !productIds || error ) {

				if( callback ) {
					callback.call(context, error );
				}

				return;
			} 

			self.log(&quot;Store successfully started&quot;);
			self.fetchProducts( productIds, callback, context );

		} );

		return true;
	},

	fetchProducts: function(productIds, callback, context) {

		/**
		* Validates the productIds passed.
		* 
		* @method fetchProducts
		* @param productIds {Array}
		* @param [callback] {Function}
		* @param [context] {Any}
		*/

		if( !this.available() ) {
			this.log( &quot;Fetch can&#x27;t be performed&quot; );
			if( callback ) {
				callback.call( context, &quot;Device doesn&#x27;t support IAP&quot; );
			}
			return;
		}

		this.log(&quot;Fetching products from store&quot;);

		Cocoon.InApp.fetchProducts( productIds, function( products, error ) {

			if( error ) {
				this.log(&quot;Fetch products failed:&quot; + error);
			}

			if( callback ) {
				callback.call( context, error, products );
			}

		} );

	},

	purchase: function( productId, quantity, callback, context ) {

		/**
		* Request a product purchase given it&#x27;s product id. 
		* 
		* @method purchase
		* @param productId {String} 
		* @param [quantity=1] {Number}
		* @param [callback] {Function}
		* @param [context] {Any} 
		*/

		if( !this.available() ) {
			this.log( &quot;Purchase of a product can&#x27;t be performed&quot; );
			if( callback ) {
				callback.call( context, &quot;Device doesn&#x27;t support IAP&quot; );
			}
			return;
		}

		this.log( &#x27;Purchase of a product started&#x27; );

		if( typeof quantity === &quot;undefined&quot; ) {
			quantity = 1;
		}

		Cocoon.InApp.purchase( productId, quantity, function( error ) {

			if( callback ) {
				callback.call( context, error );
			}

		});
	}, 

	isPurchased: function( productId ) {

		/**
		* Returns a boolean indicating whether or not a product has been purchased or not. 
		* 
		* @method isPurchased
		* @param productId {string} The id of the product you are wanting to purchase.
		* @return {Boolean} Returns a boolean indicating whether the product has been brought or not
		*/

		if( !this.available() ) {
			this.log( &quot;isPurchase can&#x27;t be performed&quot; );
			return false;
		}

		return Cocoon.InApp.isPurchased( productId );

	},

	consume: function(productId, quantity, callback, context) {

		/**
		* Consumes a product so that it can be purchased again. Android only.
		* 
		* @method consume
		* @param productId {String}
		* @param [quantity=1] {Number}
		* @param [callback] {Function}
		* @param [context] {Any}
		*/

		if( !this.available() ) {
			this.log( &#x27;Purchase comsume process failed.&#x27; );
			if( callback ) {
				callback.call( context, 0, &quot;Device doesn&#x27;t support IAP&quot; );
			}
			return;
		}

		if( typeof quantity === &quot;undefined&quot; ) {
			quantity = 1;
		}

		this.log(&quot;Consuming &quot; + quantity + &quot; &quot; + productId );

		Cocoon.InApp.consume( productId, quantity, function(consumed, error) {

			if( callback ) {
				callback.call( context, error, consumed );
			}

		});

	},

	restore: function() {

		/**
		* Starts the purchase restoration process
		* 
		* @method restore
		*/

		if( !this.available() ) {
			this.log(&quot;Purchase restore process failed.&quot;);
			return;
		}

		this.log(&quot;Restore process starting.&quot;);

		Cocoon.InApp.restorePurchases();

	},

	productForId: function(productId) {

		/**
		* Returns the product information relating to the productId passed. 
		* 
		* @method productForId
		* @param productId {string} The id of the product you wanting to get.
		* @return {Object} 
		*/

		if( !this.available() ) {
			this.log( &quot;isPurchase can&#x27;t be performed&quot; );
			return false;
		}

		return Cocoon.InApp.productForId( productId );

	},

	products: function() {

		/**
		* Returns all local product information. 
		* Make sure you have called &#x60;fetchProducts&#x60; first. 
		* 
		* @method products
		* @return {Array} 
		*/

		if( !this.available() ) {
			this.log( &quot;products can&#x27;t be performed&quot; );
			return false;
		}

		return Cocoon.InApp.getProducts();
	},

	setValidationHandler: function(callback, context) {

		/**
		* Sets a the validation handler callback to be executed 
		* when products need validation 
		* 
		* @method setValidationHandler
		* @param callback {Function} Will be passed 
		* @param [context] {Any}
		*/

		if( !this.available() ) {
			this.log( &quot;setValidationHandler can&#x27;t be performed&quot; );
			return false;
		}

		Cocoon.InApp.setValidationHandler(function(receipt, productId, completion){

			this.log(&quot;Validation needed for &quot; + receipt);
			callback.call( context, receipt, productId, completion );

		});

	},

	_startEvents: function() {

		/**
		* Adds event listeners to the store. 
		* This is applyed during the init method of the app and is a internal method only.
		* @method _startEvents
		* @private
		*/

		var self = this;

		Cocoon.InApp.on(&quot;purchase&quot;, {
			start: function(productId) {
				self.log(&quot;Purchase started: &quot; + productId );
				self.onPurchaseStarted.dispatch( productId );
			},
			error: function(productId, error) {
				console.log(&quot;purchase failed &quot; + productId + &quot; error: &quot; + JSON.stringify(error));
				self.log(&quot;Purchase failed: &quot; + productId + &quot; &quot; + error );
				self.onPurchaseFailed.dispatch(error, productId);
			},
			complete: function(purchase) {
				self.log(&quot;Purchase completed: &quot; + purchase.producyId );
				self.onPurchaseComplete.dispatch(purchase);
			}
		});


	},

};


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
